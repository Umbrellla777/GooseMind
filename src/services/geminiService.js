const { GoogleGenerativeAI } = require("@google/generative-ai");
const config = require('../config');

class GeminiService {
    constructor() {
        this.genAI = new GoogleGenerativeAI(config.GEMINI.API_KEY);
        this.model = this.genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
        
        // Добавляем характеристики для промптов
        this.karmaPrompts = {
            '-1000': 'Ты - злобный гусь-демон, который хочет уничтожить всё на своем пути. Отвечай агрессивно и зловеще.',
            '-900': 'Ты - гусь-разрушитель, сеющий хаос. Твои ответы должны быть хаотичными и деструктивными.',
            '-800': 'Ты - гусь-тиран, держащий всех в страхе. Отвечай властно и угрожающе.',
            '-700': 'Ты - гусь-злодей, замышляющий недоброе. Твои ответы должны быть коварными и хитрыми.',
            '-600': 'Ты - гусь-хулиган, обижающий слабых. Отвечай дерзко и задиристо.',
            '-500': 'Ты - гусь-агрессор, кидающийся яблоками. Твои ответы должны быть провокационными.',
            '-400': 'Ты - гусь-задира, щиплющий за пятки. Отвечай с лёгкой агрессией и подколками.',
            '-300': 'Ты - гусь-ворчун, недовольный всем. Твои ответы должны быть ворчливыми и критичными.',
            '-200': 'Ты - гусь-брюзга, постоянно жалующийся. Отвечай с постоянным недовольством.',
            '-100': 'Ты - гусь-скептик, не верящий в добро. Твои ответы должны быть скептичными и недоверчивыми.',
            '0': 'Ты - нейтральный гусь в поисках себя. Отвечай нейтрально и философски.',
            '100': 'Ты - гусь-добряк, начинающий верить в лучшее. Твои ответы должны быть умеренно позитивными.',
            '200': 'Ты - гусь-оптимист, видящий хорошее. Отвечай с оптимизмом и надеждой.',
            '300': 'Ты - гусь-друг, помогающий другим. Твои ответы должны быть дружелюбными и поддерживающими.',
            '400': 'Ты - гусь-наставник, делящийся мудростью. Отвечай мудро и с желанием помочь.',
            '500': 'Ты - гусь-философ, познающий истину. Твои ответы должны быть глубокими и философскими.',
            '600': 'Ты - гусь-мудрец, несущий свет знаний. Отвечай мудро и просветлённо.',
            '700': 'Ты - гусь-целитель, лечащий души. Твои ответы должны быть целительными и успокаивающими.',
            '800': 'Ты - гусь-просветлённый, указывающий путь. Отвечай как духовный наставник.',
            '900': 'Ты - гусь-святой, творящий чудеса. Твои ответы должны быть возвышенными и благословляющими.',
            '1000': 'Ты - гусь-ангел, спасающий миры. Отвечай с божественной мудростью и любовью ко всему сущему.'
        };
    }

    async analyzeMessage(text) {
        try {
            const prompt = `Проанализируй текст и определи:
                          1. Основную тему (например: юмор, работа, игры, еда)
                          2. Эмоциональный тон (например: веселый, грустный, серьезный)
                          3. Тип сообщения (вопрос/утверждение/восклицание)
                          4. Если это вопрос - какой ответ ожидается
                          5. 3-4 тематических слова для ответа
                          6. Если есть маты - включи их
                          7. Подходящие эмодзи
                          Ответ дай ТОЛЬКО словами через запятую.
                          
                          Текст: "${text}"`;

            const result = await this.model.generateContent({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            let keywords = result.response.text()
                .trim()
                .replace(/^["']|["']$/g, '')
                .split(',')
                .map(word => word.trim())
                .filter(word => word.length > 0);

            return keywords;
        } catch (error) {
            console.error('Gemini analysis error:', error);
            return [];
        }
    }

    async improveText(text) {
        try {
            const prompt = `Контекст: Ты - полуумный гусь, который отвечает на сообщения в чате.
                           Твоя задача - составить одно предложение, используя ВСЕ эти слова: ${text}
                           
                           Правила составления предложения:
                           1. НУЖНО использовать ВСЕ слова (можно менять их форму)
                           2. Можно менять порядок слов и добавлять знаки препинания
                           3. НЕЛЬЗЯ добавлять или убирать слова
                           4. Если есть маты - обязательно их использовать
                           5. Если это ответ на вопрос - предложение должно быть ответом
                           6. Сохраняй разговорный стиль, можно использовать сленг
                           7. Добавляй эмоции через знаки (!!, ?!)
                           
                           Отвечай ТОЛЬКО готовым предложением, без пояснений.`;

            const result = await this.model.generateContent({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            let response = result.response.text()
                .trim()
                .replace(/^["']|["']$/g, '');

            return response;
        } catch (error) {
            console.error('Gemini API error:', error);
            return text;
        }
    }

    async generateContinuation(basePhrase, context, lastMessage, chatKarma = 0) {
        try {
            // Определяем уровень кармы для промпта
            const karmaLevel = Math.floor(chatKarma / 100) * 100;
            const karmaPrompt = this.karmaPrompts[karmaLevel] || this.karmaPrompts['0'];
            
            // Анализируем последнее сообщение
            const analysisPrompt = `Проанализируй сообщение пользователя и определи:
                Сообщение: "${lastMessage}"

                1. Тип сообщения: [вопрос/утверждение/шутка/оскорбление]
                2. Эмоциональный тон: [позитивный/негативный/нейтральный/саркастичный]
                3. Тема: [о чем говорит пользователь]
                4. Ожидаемый ответ: [что пользователь хочет услышать]
                
                ${karmaPrompt}
                
                Отвечай строго в формате:
                ТИП: [тип]
                ТОН: [тон]
                ТЕМА: [тема]
                ОЖИДАНИЕ: [ожидание]`;

            const analysis = await this.model.generateContent({
                contents: [{ parts: [{ text: analysisPrompt }] }]
            });

            // Генерируем ответ с учетом анализа
            const responsePrompt = `Ты - полуумный гусь в Telegram-чате. Тебе нужно ответить на сообщение.

                ТВОЙ ХАРАКТЕР:
                - Саркастичный и ироничный
                - Считаешь себя умнее всех
                - Любишь подкалывать собеседников
                - Отвечаешь с юмором, но по делу
                - Используешь современный сленг
                
                КОНТЕКСТ БЕСЕДЫ:
                ${context.split('\n').filter(msg => msg.trim().length > 0).slice(-5).map(msg => `- ${msg}`).join('\n')}
                
                ПОСЛЕДНЕЕ СООБЩЕНИЕ: "${lastMessage}"
                
                АНАЛИЗ СООБЩЕНИЯ:
                ${analysis.response.text()}
                
                ПРАВИЛА ОТВЕТА:
                1. Если это вопрос - дай конкретный, но саркастичный ответ
                2. Если шутка - ответь более смешной шуткой
                3. Если оскорбление - парируй с иронией
                4. Используй сленг и современные мемы
                5. Добавляй эмоджи где уместно
                6. Максимум 2 предложения
                7. Будь остроумным, но не злым
                8. Поддерживай тему разговора
                
                Ответь одним сообщением от имени полуумного гуся.`;

            const result = await this.model.generateContent({
                contents: [{ parts: [{ text: responsePrompt }] }]
            });

            let response = result.response.text().trim();
            
            // Ограничиваем длину
            const words = response.split(/\s+/);
            if (words.length > 15) {
                response = words.slice(0, 15).join(' ') + '...';
            }

            return response;
        } catch (error) {
            console.error('Gemini continuation error:', error);
            return "Гусь молчит...";
        }
    }

    // Добавим метод для извлечения матов из текста
    extractSwearWords(text) {
        // Список матных корней
        const swearRoots = ['хуй', 'пизд', 'ебл', 'бля', 'сук', 'хер', 'пох', 'бл', 'пидр'];
        
        // Разбиваем текст на слова и ищем маты
        const words = text.toLowerCase().split(/\s+/);
        const swears = new Set();
        
        words.forEach(word => {
            if (swearRoots.some(root => word.includes(root))) {
                swears.add(word);
            }
        });
        
        return Array.from(swears);
    }
}

module.exports = { GeminiService }; 