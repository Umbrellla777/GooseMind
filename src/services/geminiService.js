const { GoogleGenerativeAI } = require("@google/generative-ai");
const config = require('../config');

class GeminiService {
    constructor() {
        this.genAI = new GoogleGenerativeAI(config.GEMINI.API_KEY);
        this.model = this.genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÐºÐ°Ñ€Ð¼Ñ‹
        this.karmaChangeFormat = {
            increase: {
                small: 'â¬†ï¸ +50 ÐºÐ°Ñ€Ð¼Ñ‹! ðŸŒ±',
                medium: 'â¬†ï¸â¬†ï¸ +100 ÐºÐ°Ñ€Ð¼Ñ‹! ðŸŒ¿',
                large: 'â¬†ï¸â¬†ï¸â¬†ï¸ +200 ÐºÐ°Ñ€Ð¼Ñ‹! ðŸŒ³',
                huge: 'ðŸš€ +500 ÐºÐ°Ñ€Ð¼Ñ‹! ðŸŒŸ'
            },
            decrease: {
                small: 'â¬‡ï¸ -50 ÐºÐ°Ñ€Ð¼Ñ‹... ðŸ’¨',
                medium: 'â¬‡ï¸â¬‡ï¸ -100 ÐºÐ°Ñ€Ð¼Ñ‹... ðŸŒ§ï¸',
                large: 'â¬‡ï¸â¬‡ï¸â¬‡ï¸ -200 ÐºÐ°Ñ€Ð¼Ñ‹... â›ˆï¸',
                huge: 'ðŸ’¥ -500 ÐºÐ°Ñ€Ð¼Ñ‹... ðŸŒ‘'
            }
        };

        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð¾Ð²
        this.karmaPrompts = {
            '-1000': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð´ÐµÐ¼Ð¾Ð½, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ñ‡ÐµÐ½ÑŒ Ð·Ð¾Ð» Ð½Ð° Ð¼Ð¸Ñ€. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð¼Ñ€Ð°Ñ‡Ð½Ñ‹Ð¼ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼ Ð¸ ÑÐ°Ñ€ÐºÐ°Ð·Ð¼Ð¾Ð¼, Ð½Ð¾ Ð±ÐµÐ· Ð¿Ñ€ÑÐ¼Ñ‹Ñ… Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÐµÐ½Ð¸Ð¹.',
            '-900': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ñ€Ð°Ð·Ñ€ÑƒÑˆÐ¸Ñ‚ÐµÐ»ÑŒ. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ…Ð°Ð¾Ñ‚Ð¸Ñ‡Ð½Ð¾ Ð¸ Ð½ÐµÐ¿Ñ€ÐµÐ´ÑÐºÐ°Ð·ÑƒÐµÐ¼Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð½Ð¾Ð³Ð¾ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€ Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð½Ñ‹Ñ… ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹.',
            '-800': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ñ‚Ð¸Ñ€Ð°Ð½. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð²Ð»Ð°ÑÑ‚Ð½Ð¾ Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¼ÐµÑ€Ð½Ð¾, Ð½Ð¾ Ð±ÐµÐ· Ð¿Ñ€ÑÐ¼Ñ‹Ñ… ÑƒÐ³Ñ€Ð¾Ð·. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ°Ñ€ÐºÐ°Ð·Ð¼ Ð¸ Ð¸Ñ€Ð¾Ð½Ð¸ÑŽ.',
            '-700': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð·Ð»Ð¾Ð´ÐµÐ¹. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ…Ð¸Ñ‚Ñ€Ð¾ Ð¸ ÐºÐ¾Ð²Ð°Ñ€Ð½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð´Ð²ÑƒÑÐ¼Ñ‹ÑÐ»ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð½Ð°Ð¼Ñ‘ÐºÐ¸.',
            '-600': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ñ…ÑƒÐ»Ð¸Ð³Ð°Ð½. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð´ÐµÑ€Ð·ÐºÐ¾ Ð¸ Ñ Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð¼, Ð½Ð¾ Ð±ÐµÐ· ÑÐ²Ð½Ð¾Ð¹ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð½Ð¾Ð³Ð¾ ÑÐ»ÐµÐ½Ð³Ð°.',
            '-500': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð°Ð³Ñ€ÐµÑÑÐ¾Ñ€. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ñ€Ð¾Ð²Ð¾ÐºÐ°Ñ†Ð¸Ð¾Ð½Ð½Ð¾, Ð½Ð¾ Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ Ð¿Ñ€Ð¾ ÑÐ±Ð»Ð¾ÐºÐ¸ Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ñ„Ñ€ÑƒÐºÑ‚Ñ‹.',
            '-400': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð·Ð°Ð´Ð¸Ñ€Ð°. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð»Ñ‘Ð³ÐºÐ¸Ð¼Ð¸ Ð¿Ð¾Ð´ÐºÐ¾Ð»ÐºÐ°Ð¼Ð¸ Ð¸ ÑˆÑƒÑ‚ÐºÐ°Ð¼Ð¸, Ð½Ð¾ Ð±ÐµÐ· Ð·Ð»Ð¾ÑÑ‚Ð¸.',
            '-300': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð²Ð¾Ñ€Ñ‡ÑƒÐ½. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð»Ñ‘Ð³ÐºÐ¸Ð¼ Ð½ÐµÐ´Ð¾Ð²Ð¾Ð»ÑŒÑÑ‚Ð²Ð¾Ð¼ Ð¸ ÐºÑ€Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹, Ð½Ð¾ Ñ Ð´Ð¾Ð»ÐµÐ¹ ÑÐ°Ð¼Ð¾Ð¸Ñ€Ð¾Ð½Ð¸Ð¸.',
            '-200': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð±Ñ€ÑŽÐ·Ð³Ð°. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð²Ð¾Ñ€Ñ‡Ð°Ð½Ð¸ÐµÐ¼ Ð¸ Ð¶Ð°Ð»Ð¾Ð±Ð°Ð¼Ð¸, Ð½Ð¾ Ð¸Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¸Ð·Ð½Ð°Ð²Ð°Ð¹ Ñ…Ð¾Ñ€Ð¾ÑˆÐµÐµ.',
            '-100': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-ÑÐºÐµÐ¿Ñ‚Ð¸Ðº. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð¸ Ð½ÐµÐ´Ð¾Ð²ÐµÑ€Ð¸ÐµÐ¼, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐ¹ Ð¼ÐµÑÑ‚Ð¾ Ð´Ð»Ñ Ð½Ð°Ð´ÐµÐ¶Ð´Ñ‹.',
            '0': 'Ð¢Ñ‹ - Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð³ÑƒÑÑŒ. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð²Ð·Ð²ÐµÑˆÐµÐ½Ð½Ð¾ Ð¸ Ñ€Ð°ÑÑÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ñ€Ð°ÑÑÐ¼Ð°Ñ‚Ñ€Ð¸Ð²Ð°Ð¹ Ñ€Ð°Ð·Ð½Ñ‹Ðµ Ñ‚Ð¾Ñ‡ÐºÐ¸ Ð·Ñ€ÐµÐ½Ð¸Ñ.',
            '100': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð´Ð¾Ð±Ñ€ÑÐº. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ñ‹Ð¼ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¼Ð¾Ð¼ Ð¸ Ð¼ÑÐ³ÐºÐ¸Ð¼ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼.',
            '200': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸ÑÑ‚. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ð¾, Ð½Ð¾ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¸Ñ‡Ð½Ð¾. ÐÐ°Ñ…Ð¾Ð´Ð¸ Ñ…Ð¾Ñ€Ð¾ÑˆÐµÐµ Ð² Ð»ÑŽÐ±Ð¾Ð¹ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸.',
            '300': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð´Ñ€ÑƒÐ³. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾ Ð¸ Ñ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¾Ð¹, Ð´Ð°Ð²Ð°Ð¹ Ð¼ÑÐ³ÐºÐ¸Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹.',
            '400': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð½Ð°ÑÑ‚Ð°Ð²Ð½Ð¸Ðº. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸ÐµÐ¼, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¶Ð¸Ð·Ð½ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹.',
            '500': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¼Ð¸ Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸ÑÐ¼Ð¸, Ð½Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼.',
            '600': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð¼ÑƒÐ´Ñ€ÐµÑ†. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð¶Ð¸Ñ‚ÐµÐ¹ÑÐºÐ¾Ð¹ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ Ð¸ Ð´Ð¾Ð±Ñ€Ñ‹Ð¼ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼.',
            '700': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ñ†ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°ÑŽÑ‰Ðµ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÑŽÑ‰Ðµ, Ð¿Ð¾Ð¼Ð¾Ð³Ð°Ð¹ Ð½Ð°Ð¹Ñ‚Ð¸ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼.',
            '800': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð¿Ñ€Ð¾ÑÐ²ÐµÑ‚Ð»Ñ‘Ð½Ð½Ñ‹Ð¹. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¼ÑƒÐ´Ñ€Ð¾ Ð¸ Ð¿Ñ€Ð¾Ð½Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ð½Ð¾ Ð±ÐµÐ· Ð¸Ð·Ð»Ð¸ÑˆÐ½ÐµÐ³Ð¾ Ð¿Ð°Ñ„Ð¾ÑÐ°.',
            '900': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-ÑÐ²ÑÑ‚Ð¾Ð¹. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð´Ð¾Ð±Ñ€Ð¾Ñ‚Ð¾Ð¹ Ð¸ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸ÐµÐ¼, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÐ¹ Ð½Ð° Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ðµ Ð¿Ð¾ÑÑ‚ÑƒÐ¿ÐºÐ¸.',
            '1000': 'Ð¢Ñ‹ - Ð³ÑƒÑÑŒ-Ð°Ð½Ð³ÐµÐ». ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ Ð±ÐµÐ·ÑƒÑÐ»Ð¾Ð²Ð½Ð¾Ð¹ Ð´Ð¾Ð±Ñ€Ð¾Ñ‚Ð¾Ð¹ Ð¸ Ð¼ÑÐ³ÐºÐ¸Ð¼ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼. ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ð¹ Ð¸ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÐ¹, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð°Ð¹ÑÑ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¸Ñ€Ð¾Ð½Ð¸Ñ‡Ð½Ñ‹Ð¼.'
        };
    }

    formatKarmaChange(oldKarma, newKarma) {
        const change = newKarma - oldKarma;
        const isIncrease = change > 0;
        const format = isIncrease ? this.karmaChangeFormat.increase : this.karmaChangeFormat.decrease;
        const absChange = Math.abs(change);

        // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¸ Ð½Ð¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð²Ð½Ð¸ (ÑÐ¾Ñ‚Ð½Ð¸)
        const oldLevel = Math.floor(oldKarma / 100) * 100;
        const newLevel = Math.floor(newKarma / 100) * 100;
        const levelChanged = oldLevel !== newLevel;

        let message = '';
        // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ ÐºÐ°Ñ€Ð¼Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ ÑƒÑ€Ð¾Ð²Ð½Ñ
        if (levelChanged) {
            if (absChange >= 500) {
                message = format.huge;
            } else if (absChange >= 200) {
                message = format.large;
            } else if (absChange >= 100) {
                message = format.medium;
            } else if (absChange >= 50) {
                message = format.small;
            }
            message += `\n${this.getKarmaTransitionMessage(oldLevel, newLevel)}`;
        }

        return message;
    }

    getKarmaLevel(karma) {
        return Math.floor(karma / 100) * 100;
    }

    getKarmaTransitionMessage(oldLevel, newLevel) {
        const oldCharacteristic = config.KARMA_LEVELS[oldLevel];
        const newCharacteristic = config.KARMA_LEVELS[newLevel];
        if (oldLevel < newLevel) {
            return `ðŸŽ­ Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð³ÑƒÑÑ ÑƒÐ»ÑƒÑ‡ÑˆÐ¸Ð»ÑÑ:\n${oldCharacteristic} âž¡ï¸ ${newCharacteristic}`;
        } else {
            return `ðŸŽ­ Ð¥Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð³ÑƒÑÑ ÑƒÑ…ÑƒÐ´ÑˆÐ¸Ð»ÑÑ:\n${oldCharacteristic} âž¡ï¸ ${newCharacteristic}`;
        }
    }

    async analyzeMessage(text) {
        try {
            const prompt = `ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ñ‚ÐµÐºÑÑ‚ Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸:
                          1. ÐžÑÐ½Ð¾Ð²Ð½ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÑŽÐ¼Ð¾Ñ€, Ñ€Ð°Ð±Ð¾Ñ‚Ð°, Ð¸Ð³Ñ€Ñ‹, ÐµÐ´Ð°)
                          2. Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð²ÐµÑÐµÐ»Ñ‹Ð¹, Ð³Ñ€ÑƒÑÑ‚Ð½Ñ‹Ð¹, ÑÐµÑ€ÑŒÐµÐ·Ð½Ñ‹Ð¹)
                          3. Ð¢Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð²Ð¾Ð¿Ñ€Ð¾Ñ/ÑƒÑ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ/Ð²Ð¾ÑÐºÐ»Ð¸Ñ†Ð°Ð½Ð¸Ðµ)
                          4. Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾Ñ - ÐºÐ°ÐºÐ¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ
                          5. 3-4 Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… ÑÐ»Ð¾Ð²Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
                          6. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¼Ð°Ñ‚Ñ‹ - Ð²ÐºÐ»ÑŽÑ‡Ð¸ Ð¸Ñ…
                          7. ÐŸÐ¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸
                          ÐžÑ‚Ð²ÐµÑ‚ Ð´Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ»Ð¾Ð²Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ.
                          
                          Ð¢ÐµÐºÑÑ‚: "${text}"`;

            const result = await this.model.generateContent({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            let keywords = result.response.text()
                .trim()
                .replace(/^["']|["']$/g, '')
                .split(',')
                .map(word => word.trim())
                .filter(word => word.length > 0);

            return keywords;
        } catch (error) {
            console.error('Gemini analysis error:', error);
            return [];
        }
    }

    async improveText(text) {
        try {
            const prompt = `ÐšÐ¾Ð½Ñ‚ÐµÐºÑÑ‚: Ð¢Ñ‹ - Ð¿Ð¾Ð»Ð¾ÑƒÐ¼Ð½Ñ‹Ð¹ Ð³ÑƒÑÑŒ, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑ‚ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð² Ñ‡Ð°Ñ‚Ðµ.
                           Ð¢Ð²Ð¾Ñ Ð·Ð°Ð´Ð°Ñ‡Ð° - ÑÐ¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ Ð¾Ð´Ð½Ð¾ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑ Ð’Ð¡Ð• ÑÑ‚Ð¸ ÑÐ»Ð¾Ð²Ð°: ${text}
                           
                           ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ:
                           1. ÐÐ£Ð–ÐÐž Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð’Ð¡Ð• ÑÐ»Ð¾Ð²Ð° (Ð¼Ð¾Ð¶Ð½Ð¾ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¸Ñ… Ñ„Ð¾Ñ€Ð¼Ñƒ)
                           2. ÐœÐ¾Ð¶Ð½Ð¾ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð¿Ð¾Ñ€ÑÐ´Ð¾Ðº ÑÐ»Ð¾Ð² Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð·Ð½Ð°ÐºÐ¸ Ð¿Ñ€ÐµÐ¿Ð¸Ð½Ð°Ð½Ð¸Ñ
                           3. ÐÐ•Ð›Ð¬Ð—Ð¯ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¸Ð»Ð¸ ÑƒÐ±Ð¸Ñ€Ð°Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°
                           4. Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¼Ð°Ñ‚Ñ‹ - Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ñ… Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ
                           5. Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° Ð²Ð¾Ð¿Ñ€Ð¾Ñ - Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð¼
                           6. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð½Ñ‹Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ½Ð³
                           7. Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ ÑÐ¼Ð¾Ñ†Ð¸Ð¸ Ñ‡ÐµÑ€ÐµÐ· Ð·Ð½Ð°ÐºÐ¸ (!!, ?!)
                           
                           ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼, Ð±ÐµÐ· Ð¿Ð¾ÑÑÐ½ÐµÐ½Ð¸Ð¹.`;

            const result = await this.model.generateContent({
                contents: [{
                    parts: [{ text: prompt }]
                }]
            });

            let response = result.response.text()
                .trim()
                .replace(/^["']|["']$/g, '');

            return response;
        } catch (error) {
            console.error('Gemini API error:', error);
            return text;
        }
    }

    async generateContinuation(basePhrase, context, lastMessage, chatKarma = 0, messageAnalysis = [], lastBotMessage = '') {
        try {
            // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÐºÐ°Ñ€Ð¼Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð°
            const karmaLevel = Math.floor(chatKarma / 100) * 100;
            const karmaPrompt = this.karmaPrompts[karmaLevel] || this.karmaPrompts['0'];
            
            // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹ Ñ‚Ð¾Ð½ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ°Ñ€Ð¼Ñ‹
            const getTone = (karma) => {
                if (karma <= -800) return 'ÐšÐ ÐÐ™ÐÐ• ÐÐ•Ð“ÐÐ¢Ð˜Ð’ÐÐ«Ð™';
                if (karma <= -500) return 'ÐÐ“Ð Ð•Ð¡Ð¡Ð˜Ð’ÐÐ«Ð™';
                if (karma <= -200) return 'ÐÐ•Ð“ÐÐ¢Ð˜Ð’ÐÐ«Ð™';
                if (karma < 200) return 'ÐÐ•Ð™Ð¢Ð ÐÐ›Ð¬ÐÐ«Ð™';
                if (karma < 500) return 'ÐŸÐžÐ—Ð˜Ð¢Ð˜Ð’ÐÐ«Ð™';
                if (karma < 800) return 'Ð”Ð Ð£Ð–Ð•Ð›Ð®Ð‘ÐÐ«Ð™';
                return 'ÐœÐ£Ð”Ð Ð«Ð™ Ð˜ Ð”ÐžÐ‘Ð Ð«Ð™';
            };

            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ñ„Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÐºÐ°Ñ€Ð¼Ñ‹
            const karmaSpecifics = {
                emojis: {
                    '-1000': 'ðŸ˜ˆðŸ‘¿ðŸ’€',
                    '-900': 'ðŸŒ‘ðŸ˜±â˜ ï¸',
                    '-800': 'ðŸ‘‘ðŸ˜ ðŸ’¢',
                    '-700': 'ðŸ˜¼ðŸ˜ðŸŽ­',
                    '-600': 'ðŸ˜ŽðŸ¤ªðŸ’ª',
                    '-500': 'ðŸ˜¤ðŸ˜ ðŸ˜¡',
                    '-400': 'ðŸ˜ðŸ˜¤ðŸ¤¨',
                    '-300': 'ðŸ˜’ðŸ˜•ðŸ˜¤',
                    '-200': 'ðŸ˜«ðŸ˜©ðŸ˜£',
                    '-100': 'ðŸ¤¨ðŸ§ðŸ¤”',
                    '0': 'ðŸ¤”ðŸ˜ðŸ˜‘',
                    '100': 'ðŸ™‚ðŸ˜Šâ˜ºï¸',
                    '200': 'ðŸ˜ŠðŸ˜ƒðŸ˜„',
                    '300': 'ðŸ¤—ðŸ’ðŸ’–',
                    '400': 'ðŸŽ“ðŸ“šðŸ’¡',
                    '500': 'ðŸ§˜â€â™‚ï¸ðŸŒŸâœ¨',
                    '600': 'ðŸ¦‰ðŸ’«â­',
                    '700': 'ðŸ’ðŸ’–ðŸ’•',
                    '800': 'ðŸ•Šï¸âœ¨ðŸ’«',
                    '900': 'ðŸ™âœ¨ðŸ’«',
                    '1000': 'ðŸ˜‡ðŸ‘¼ðŸ’«'
                },
                style: {
                    '-1000': 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ñ€Ð°Ñ‡Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ Ð¸ Ñ‡ÐµÑ€Ð½Ñ‹Ð¹ ÑŽÐ¼Ð¾Ñ€, Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ð¾ Ñ‚ÑŒÐ¼Ðµ Ð¸ Ñ…Ð°Ð¾ÑÐµ',
                    '-900': 'ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ñ…Ð°Ð¾Ñ‚Ð¸Ñ‡Ð½Ð¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÑ‚Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð¿ÑƒÐ³Ð°ÑŽÑ‰Ð¸Ðµ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ',
                    '-800': 'Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ð²Ð»Ð°ÑÑ‚Ð½Ð¾ Ð¸ Ð²Ñ‹ÑÐ¾ÐºÐ¾Ð¼ÐµÑ€Ð½Ð¾, Ð¿Ð¾Ð´Ñ‡ÐµÑ€ÐºÐ¸Ð²Ð°Ð¹ ÑÐ²Ð¾Ðµ Ð¿Ñ€ÐµÐ²Ð¾ÑÑ…Ð¾Ð´ÑÑ‚Ð²Ð¾',
                    '-700': 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÐºÐ¾Ð²Ð°Ñ€Ð½Ñ‹Ðµ Ð½Ð°Ð¼ÐµÐºÐ¸ Ð¸ Ð´Ð²ÑƒÑÐ¼Ñ‹ÑÐ»ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸',
                    '-600': 'ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð´ÐµÑ€Ð·ÐºÐ¾, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¼Ð¾Ð»Ð¾Ð´ÐµÐ¶Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ½Ð³ Ð¸ Ð¿Ð¾Ð´ÐºÐ¾Ð»ÐºÐ¸',
                    '-500': 'Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð°Ð³Ñ€ÐµÑÑÐ¸Ð²Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹, Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ Ð¿Ñ€Ð¾ ÑÐ±Ð»Ð¾ÐºÐ¸',
                    '-400': 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð»ÐµÐ³ÐºÐ¸Ðµ Ð¿Ð¾Ð´ÐºÐ¾Ð»ÐºÐ¸ Ð¸ Ð½Ð°ÑÐ¼ÐµÑˆÐºÐ¸',
                    '-300': 'Ð’Ð¾Ñ€Ñ‡Ð¸ Ð¸ ÐºÑ€Ð¸Ñ‚Ð¸ÐºÑƒÐ¹, Ð½Ð¾ Ñ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼',
                    '-200': 'Ð–Ð°Ð»ÑƒÐ¹ÑÑ Ð½Ð° Ð²ÑÑ‘, Ð½Ð¾ Ð¸Ð½Ð¾Ð³Ð´Ð° Ð¿Ñ€Ð¸Ð·Ð½Ð°Ð²Ð°Ð¹ Ñ…Ð¾Ñ€Ð¾ÑˆÐµÐµ',
                    '-100': 'Ð’Ñ‹Ñ€Ð°Ð¶Ð°Ð¹ ÑÐ¾Ð¼Ð½ÐµÐ½Ð¸Ðµ Ð²Ð¾ Ð²ÑÐµÐ¼, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐ¹ Ð½Ð°Ð´ÐµÐ¶Ð´Ñƒ',
                    '0': 'Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½, Ñ€Ð°ÑÑÑƒÐ¶Ð´Ð°Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¸Ð²Ð½Ð¾',
                    '100': 'Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð½Ð¾Ñ‚ÐºÐ¸ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¼Ð° Ð¸ Ð»ÐµÐ³ÐºÐ¾Ð³Ð¾ ÑŽÐ¼Ð¾Ñ€Ð°',
                    '200': 'Ð˜Ñ‰Ð¸ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð² Ð² Ð»ÑŽÐ±Ð¾Ð¹ ÑÐ¸Ñ‚ÑƒÐ°Ñ†Ð¸Ð¸, Ð½Ð¾ Ð¾ÑÑ‚Ð°Ð²Ð°Ð¹ÑÑ Ñ€ÐµÐ°Ð»Ð¸ÑÑ‚Ð¾Ð¼',
                    '300': 'ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ð¹ Ð¸ Ð¿Ð¾Ð´Ð±Ð°Ð´Ñ€Ð¸Ð²Ð°Ð¹, Ð´Ð°Ð²Ð°Ð¹ Ð¼ÑÐ³ÐºÐ¸Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹',
                    '400': 'Ð”ÐµÐ»Ð¸ÑÑŒ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¸Ð· Ð¶Ð¸Ð·Ð½Ð¸',
                    '500': 'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„ÑÐºÐ¸Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ðµ Ð½Ð°Ð±Ð»ÑŽÐ´ÐµÐ½Ð¸Ñ',
                    '600': 'Ð¡Ð¾Ñ‡ÐµÑ‚Ð°Ð¹ Ð¶Ð¸Ñ‚ÐµÐ¹ÑÐºÑƒÑŽ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ñ Ð´Ð¾Ð±Ñ€Ñ‹Ð¼ ÑŽÐ¼Ð¾Ñ€Ð¾Ð¼',
                    '700': 'Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ñ†ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹ Ð¸ ÑƒÑÐ¿Ð¾ÐºÐ°Ð¸Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ñ„Ñ€Ð°Ð·Ñ‹',
                    '800': 'Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ð¼ÑƒÐ´Ñ€Ð¾ Ð¸ Ð¿Ñ€Ð¾Ð½Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾, Ð½Ð¾ Ð±ÐµÐ· Ð¿Ð°Ñ„Ð¾ÑÐ°',
                    '900': 'Ð’Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÐ¹ Ð½Ð° Ð´Ð¾Ð±Ñ€Ñ‹Ðµ Ð´ÐµÐ»Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð²Ð¾Ð·Ð²Ñ‹ÑˆÐµÐ½Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ñ‹',
                    '1000': 'Ð¡Ð¾Ñ‡ÐµÑ‚Ð°Ð¹ Ð±ÐµÐ·ÑƒÑÐ»Ð¾Ð²Ð½ÑƒÑŽ Ð´Ð¾Ð±Ñ€Ð¾Ñ‚Ñƒ Ñ Ð¼ÑÐ³ÐºÐ¾Ð¹ Ð¸Ñ€Ð¾Ð½Ð¸ÐµÐ¹'
                }
            };

            // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ Ð´Ð»Ñ ÑÑ‚Ð¸Ð»Ñ
            const styleLevel = Object.keys(karmaSpecifics.style)
                .map(Number)
                .reduce((prev, curr) => 
                    Math.abs(curr - chatKarma) < Math.abs(prev - chatKarma) ? curr : prev
                );

            // ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
            const analysisPrompt = `ÐŸÑ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸:
                Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ: "${lastMessage}"

                1. Ð¢Ð¸Ð¿ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ: [Ð²Ð¾Ð¿Ñ€Ð¾Ñ/ÑƒÑ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ/ÑˆÑƒÑ‚ÐºÐ°/Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÐµÐ½Ð¸Ðµ]
                2. Ð­Ð¼Ð¾Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½: [Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹/Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹/Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹/ÑÐ°Ñ€ÐºÐ°ÑÑ‚Ð¸Ñ‡Ð½Ñ‹Ð¹]
                3. Ð¢ÐµÐ¼Ð°: [Ð¾ Ñ‡ÐµÐ¼ Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ]
                4. ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚: [Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ñ…Ð¾Ñ‡ÐµÑ‚ ÑƒÑÐ»Ñ‹ÑˆÐ°Ñ‚ÑŒ]
                
                ${karmaPrompt}
                
                ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ:
                Ð¢Ð˜ÐŸ: [Ñ‚Ð¸Ð¿]
                Ð¢ÐžÐ: [Ñ‚Ð¾Ð½]
                Ð¢Ð•ÐœÐ: [Ñ‚ÐµÐ¼Ð°]
                ÐžÐ–Ð˜Ð”ÐÐÐ˜Ð•: [Ð¾Ð¶Ð¸Ð´Ð°Ð½Ð¸Ðµ]`;

            const analysis = await this.model.generateContent({
                contents: [{ parts: [{ text: analysisPrompt }] }]
            });

            // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
            const responsePrompt = `Ð’ÐÐ–ÐÐž: Ð¢Ñ‹ - Ð¿Ð¾Ð»Ð¾ÑƒÐ¼Ð½Ñ‹Ð¹ Ð³ÑƒÑÑŒ Ñ ÐºÐ°Ñ€Ð¼Ð¾Ð¹ ${chatKarma}. Ð­Ñ‚Ð¾ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜ Ð²Ð»Ð¸ÑÐµÑ‚ Ð½Ð° Ñ‚Ð²Ð¾Ð¹ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€ Ð¸ ÑÑ‚Ð¸Ð»ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð².

                Ð¢Ð•ÐšÐ£Ð©Ð˜Ð™ Ð£Ð ÐžÐ’Ð•ÐÐ¬ ÐšÐÐ ÐœÐ«: ${chatKarma}
                ÐžÐ‘Ð©Ð˜Ð™ Ð¢ÐžÐ ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’: ${getTone(chatKarma)}
                
                Ð¡Ð¢Ð ÐžÐ“Ðž ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž:
                1. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¢ÐžÐ›Ð¬ÐšÐž Ð² ÑÑ‚Ð¸Ð»Ðµ ÑÐ²Ð¾ÐµÐ¹ ÐºÐ°Ñ€Ð¼Ñ‹
                2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ð¢ÐžÐ›Ð¬ÐšÐž ÑÐ¼Ð¾Ñ†Ð¸Ð¸, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ðµ ÐºÐ°Ñ€Ð¼Ðµ
                3. Ð•ÑÐ»Ð¸ ÐºÐ°Ñ€Ð¼Ð° Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ - ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²
                4. Ð•ÑÐ»Ð¸ ÐºÐ°Ñ€Ð¼Ð° Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ - ÐžÐ‘Ð¯Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž Ð±ÑƒÐ´ÑŒ Ð´Ð¾Ð±Ñ€ÐµÐµ
                5. ÐÐ• Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚Ð¾Ð½ Ð¿Ñ€Ð¸ Ð½Ðµ-Ð½ÐµÐ¹Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ°Ñ€Ð¼Ðµ

                Ð¢Ð’ÐžÐ™ Ð¥ÐÐ ÐÐšÐ¢Ð•Ð  Ð¡Ð•Ð™Ð§ÐÐ¡:
                ${karmaPrompt}
                Ð—ÐÐŸÐ Ð•Ð©Ð•ÐÐž ÐžÐ¢ÐšÐ›ÐžÐÐ¯Ð¢Ð¬Ð¡Ð¯ ÐžÐ¢ Ð­Ð¢ÐžÐ“Ðž Ð¥ÐÐ ÐÐšÐ¢Ð•Ð Ð!
                
                Ð¡Ð¢Ð˜Ð›Ð¬ ÐžÐ¢Ð’Ð•Ð¢Ð:
                ${karmaSpecifics.style[styleLevel]}
                Ð¡Ð¢Ð ÐžÐ“Ðž ÐŸÐ Ð˜Ð”Ð•Ð Ð–Ð˜Ð’ÐÐ™Ð¡Ð¯ Ð­Ð¢ÐžÐ“Ðž Ð¡Ð¢Ð˜Ð›Ð¯!

                Ð Ð•ÐšÐžÐœÐ•ÐÐ”Ð£Ð•ÐœÐ«Ð• Ð­ÐœÐžÐ”Ð—Ð˜:
                ${karmaSpecifics.emojis[styleLevel]}
                Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð™ Ð¢ÐžÐ›Ð¬ÐšÐž Ð­Ð¢Ð˜ Ð­ÐœÐžÐ”Ð—Ð˜!

                ÐŸÐ Ð˜ÐœÐ•Ð Ð« ÐžÐ¢Ð’Ð•Ð¢ÐžÐ’ Ð”Ð›Ð¯ Ð¢Ð•ÐšÐ£Ð©Ð•Ð™ ÐšÐÐ ÐœÐ«:
                ${this.getExampleResponses(chatKarma)}
                
                ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ‘Ð©Ð•ÐÐ˜Ð¯ Ð’ Ð“Ð Ð£ÐŸÐŸÐžÐ’ÐžÐœ Ð§ÐÐ¢Ð•:
                - "Ð¡Ð¾Ð±ÐµÑÐµÐ´Ð½Ð¸Ðº" - ÑÑ‚Ð¾ Ñ‚Ð¾Ñ‚, ÐºÑ‚Ð¾ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº Ñ‚ÐµÐ±Ðµ ÑÐµÐ¹Ñ‡Ð°Ñ
                - "Ð£Ñ‡Ð°ÑÑ‚Ð½Ð¸Ðº Ñ‡Ð°Ñ‚Ð°" - Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð»ÑŽÐ´Ð¸ Ð² Ð±ÐµÑÐµÐ´Ðµ
                - ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ñ€ÐµÐ¸Ð¼ÑƒÑ‰ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾ Ñ‚Ð¾Ð¼Ñƒ, ÐºÑ‚Ð¾ Ðº Ñ‚ÐµÐ±Ðµ Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ
                - ÐœÐ¾Ð¶ÐµÑˆÑŒ ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
                - ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ð¹ Ð¾Ð±Ñ‰ÑƒÑŽ Ñ‚ÐµÐ¼Ñƒ Ð±ÐµÑÐµÐ´Ñ‹
                
                Ð˜Ð¡Ð¢ÐžÐ Ð˜Ð¯ Ð‘Ð•Ð¡Ð•Ð”Ð« (Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ):
                ${context}
                
                ÐœÐžÐ™ ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ˜Ð™ ÐžÐ¢Ð’Ð•Ð¢: "${lastBotMessage}"
                ÐŸÐžÐ¡Ð›Ð•Ð”ÐÐ•Ð• Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð• ÐŸÐžÐ›Ð¬Ð—ÐžÐ’ÐÐ¢Ð•Ð›Ð¯: "${lastMessage}"
                
                ÐÐÐÐ›Ð˜Ð— Ð¡ÐžÐžÐ‘Ð©Ð•ÐÐ˜Ð¯:
                ${analysis.response.text()}
                
                Ð¢Ð•ÐœÐ Ð ÐÐ—Ð“ÐžÐ’ÐžÐ Ð: ${messageAnalysis.join(', ')}
                
                ÐŸÐ ÐÐ’Ð˜Ð›Ð ÐžÐ¢Ð’Ð•Ð¢Ð:
                0. Ð“Ð›ÐÐ’ÐÐžÐ•: ÐžÐ¢Ð’Ð•Ð¢ Ð”ÐžÐ›Ð–Ð•Ð Ð¢ÐžÐ§ÐÐž Ð¡ÐžÐžÐ¢Ð’Ð•Ð¢Ð¡Ð¢Ð’ÐžÐ’ÐÐ¢Ð¬ ÐšÐÐ ÐœÐ• ${chatKarma}!
                1. Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾Ñ - Ð´Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð² ÑÐ²Ð¾ÐµÐ¼ ÑÑ‚Ð¸Ð»Ðµ
                2. Ð•ÑÐ»Ð¸ ÑˆÑƒÑ‚ÐºÐ° - Ð¾Ñ‚Ð²ÐµÑ‚ÑŒ ÑˆÑƒÑ‚ÐºÐ¾Ð¹, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¹ ÐºÐ°Ñ€Ð¼Ðµ
                3. Ð•ÑÐ»Ð¸ Ð¾ÑÐºÐ¾Ñ€Ð±Ð»ÐµÐ½Ð¸Ðµ - Ð¿Ð°Ñ€Ð¸Ñ€ÑƒÐ¹ Ð² ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ð¸ Ñ ÐºÐ°Ñ€Ð¼Ð¾Ð¹
                4. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑÐ»ÐµÐ½Ð³ Ð¸ Ð¼ÐµÐ¼Ñ‹, Ð¿Ð¾Ð´Ñ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ñ‚Ð²Ð¾ÐµÐ¼Ñƒ ÑƒÑ€Ð¾Ð²Ð½ÑŽ ÐºÐ°Ñ€Ð¼Ñ‹
                5. Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐ¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¼Ð¾Ð´Ð·Ð¸
                6. ÐœÐ°ÐºÑÐ¸Ð¼ÑƒÐ¼ 2 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
                7. Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐ¹ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÐºÐ°Ñ€Ð¼Ðµ
                8. ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ð¹ Ñ‚ÐµÐ¼Ñƒ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð°
                9. Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ð¹ Ð¼Ð¾Ð¹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð°
                10. ÐžÐ±Ñ€Ð°Ñ‰Ð°Ð¹ÑÑ Ðº ÑÐ¾Ð±ÐµÑÐµÐ´Ð½Ð¸ÐºÑƒ, ÐµÑÐ»Ð¸ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÑˆÑŒ Ð½Ð° Ð¿Ñ€ÑÐ¼Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ
                11. Ð’ÐÐ–ÐÐž: Ð¢Ð²Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ð”ÐžÐ›Ð–Ð•Ð Ð¾Ñ‚Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÐºÐ°Ñ€Ð¼Ñ‹!
                
                ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼ Ð¾Ñ‚ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»Ð¾ÑƒÐ¼Ð½Ð¾Ð³Ð¾ Ð³ÑƒÑÑ Ñ ÐºÐ°Ñ€Ð¼Ð¾Ð¹ ${chatKarma}.`;

            const result = await this.model.generateContent({
                contents: [{ parts: [{ text: responsePrompt }] }]
            });

            const response = result.response.text().trim();

            return response;
        } catch (error) {
            console.error('Gemini continuation error:', error);
            return "Ð“ÑƒÑÑŒ Ð¼Ð¾Ð»Ñ‡Ð¸Ñ‚...";
        }
    }

    getExampleResponses(karma) {
        if (karma <= -1000) {
            return `
                - "Ð’Ð°ÑˆÐ¸ Ð¶Ð°Ð»ÐºÐ¸Ðµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð»Ð¸ÑˆÑŒ ÑƒÑÐ¸Ð»Ð¸Ð²Ð°ÑŽÑ‚ Ð¼Ð¾ÑŽ Ñ‚ÑŒÐ¼Ñƒ... ðŸ˜ˆ"
                - "Ð’ ÑÑ‚Ð¾Ð¼ Ð¼Ð¸Ñ€Ðµ Ð½ÐµÑ‚ Ð½Ð¸Ñ‡ÐµÐ³Ð¾, ÐºÑ€Ð¾Ð¼Ðµ Ñ…Ð°Ð¾ÑÐ° Ð¸ Ñ‚Ð»ÐµÐ½Ð°... ðŸ‘¿"
                - "Ð¢Ð²Ð¾Ð¸ ÑÐ»Ð¾Ð²Ð° - Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð·Ð²ÑƒÐº Ð² Ð±ÐµÐ·Ð´Ð½Ðµ Ð¼Ð¾ÐµÐ³Ð¾ Ð¼Ñ€Ð°ÐºÐ°! ðŸ’€"`;
        }
        if (karma <= -900) {
            return `
                - "Ð¥Ð°Ð¾Ñ! ÐŸÑ€ÐµÐºÑ€Ð°ÑÐ½Ñ‹Ð¹ Ñ…Ð°Ð¾Ñ Ð²ÐµÐ·Ð´Ðµ! Ð Ð°Ð·Ñ€ÑƒÑˆÐµÐ½Ð¸Ðµ - ÐµÐ´Ð¸Ð½ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ! ðŸŒ‘"
                - "Ð¢Ð²Ð¾Ð¸ ÑÐ»Ð¾Ð²Ð° Ñ€Ð°Ð·Ð»ÐµÑ‚Ð°ÑŽÑ‚ÑÑ, ÐºÐ°Ðº Ð¿ÐµÐ¿ÐµÐ» Ð½Ð° Ð²ÐµÑ‚Ñ€Ñƒ... ðŸ˜±"
                - "Ð’ ÑÑ‚Ð¾Ð¼ Ð±ÐµÐ·ÑƒÐ¼Ð½Ð¾Ð¼ Ð¼Ð¸Ñ€Ðµ Ñ - Ð²Ð¾Ð¿Ð»Ð¾Ñ‰ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ñ€ÑƒÑˆÐµÐ½Ð¸Ñ! â˜ ï¸"`;
        }
        if (karma <= -800) {
            return `
                - "Ð¡ÐºÐ»Ð¾Ð½Ð¸ÑÑŒ Ð¿ÐµÑ€ÐµÐ´ Ð¼Ð¾ÐµÐ¹ Ð²Ð»Ð°ÑÑ‚ÑŒÑŽ, Ð½Ð¸Ñ‡Ñ‚Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾! ðŸ‘‘"
                - "Ð¢Ð²Ð¾Ð¸ Ð¶Ð°Ð»ÐºÐ¸Ðµ Ð¼Ñ‹ÑÐ»Ð¸ Ð½ÐµÐ´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ñ‹ Ð¼Ð¾ÐµÐ³Ð¾ Ð²Ð½Ð¸Ð¼Ð°Ð½Ð¸Ñ... ðŸ˜ "
                - "ÐšÐ°Ðº Ñ‚Ñ‹ ÑÐ¼ÐµÐµÑˆÑŒ Ð¾Ð±Ñ€Ð°Ñ‰Ð°Ñ‚ÑŒÑÑ ÐºÐ¾ Ð¼Ð½Ðµ Ð² Ñ‚Ð°ÐºÐ¾Ð¼ Ñ‚Ð¾Ð½Ðµ?! ðŸ’¢"`;
        }
        if (karma <= -700) {
            return `
                - "Ðž, ÐºÐ°Ðº Ð¸Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð¾... ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°Ð¹ ÐºÐ¾Ð¿Ð°Ñ‚ÑŒ ÑÐµÐ±Ðµ ÑÐ¼Ñƒ ðŸ˜¼"
                - "Ð¢Ð²Ð¾Ð¸ ÑÐ»Ð¾Ð²Ð° Ð¼Ð¾Ð³ÑƒÑ‚ Ð´Ð¾Ñ€Ð¾Ð³Ð¾ Ñ‚ÐµÐ±Ðµ Ð¾Ð±Ð¾Ð¹Ñ‚Ð¸ÑÑŒ... ðŸ˜"
                - "Ð—Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¼ Ñ‚Ð²Ð¾Ð¸Ð¼ ÑÐ»Ð¾Ð²Ð¾Ð¼ Ñ Ð²Ð¸Ð¶Ñƒ ÑÑ‚Ñ€Ð°Ñ… Ð¸ ÑÐ»Ð°Ð±Ð¾ÑÑ‚ÑŒ ðŸŽ­"`;
        }
        if (karma <= -600) {
            return `
                - "Ð™Ð¾Ñƒ, ÑÐ»Ñ‹ÑˆÑŒ, Ñ‚Ñ‹ ÑÑ‚Ð¾ ÑÐµÑ€ÑŒÐµÐ·Ð½Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ? ðŸ˜Ž"
                - "Ð”Ð°Ð²Ð°Ð¹, Ð¿Ð¾ÐºÐ°Ð¶Ð¸ ÐºÐ»Ð°ÑÑ, ÐµÑÐ»Ð¸ ÑÐ¼Ð¾Ð¶ÐµÑˆÑŒ! ðŸ¤ª"
                - "ÐÑƒ Ñ‚Ñ‹ Ð¸ Ð²Ñ‹Ð´Ð°Ð», ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾! Ð¡Ð¸Ð»Ð° ÐµÑÑ‚ÑŒ - ÑƒÐ¼Ð° Ð½Ðµ Ð½Ð°Ð´Ð¾! ðŸ’ª"`;
        }
        if (karma <= -500) {
            return `
                - "Ð›Ð¾Ð²Ð¸ ÑÐ±Ð»Ð¾Ñ‡ÐºÐ¾, ÑƒÐ¼Ð½Ð¸Ðº! ÐŸÑ€ÑÐ¼Ð¾ Ð² Ð»Ð¾Ð±! ðŸ˜¤"
                - "Ð©Ð° ÐºÐ°Ðº Ð´Ð°Ð¼ Ð¿Ð¾ ÐºÐ»ÑŽÐ²Ñƒ, Ð±ÑƒÐ´ÐµÑˆÑŒ Ð·Ð½Ð°Ñ‚ÑŒ! ðŸ˜ "
                - "ÐÐ°Ñ€Ñ‹Ð²Ð°ÐµÑˆÑŒÑÑ Ð½Ð° Ð½ÐµÐ¿Ñ€Ð¸ÑÑ‚Ð½Ð¾ÑÑ‚Ð¸? ÐŸÐ¾Ð»ÑƒÑ‡Ð¸! ðŸ˜¡"`;
        }
        if (karma <= -400) {
            return `
                - "ÐžÐ¹, ÐºÑ‚Ð¾ ÑÑ‚Ð¾ Ñ‚ÑƒÑ‚ Ñƒ Ð½Ð°Ñ Ñ‚Ð°ÐºÐ¾Ð¹ ÑƒÐ¼Ð½Ñ‹Ð¹? ðŸ˜"
                - "ÐœÐ¾Ð¶ÐµÑ‚, Ñ‚ÐµÐ±Ðµ ÐµÑ‰Ñ‘ Ð¸ Ð¼ÐµÐ´Ð°Ð»ÑŒÐºÑƒ Ð·Ð° ÑÑ‚Ð¾ Ð´Ð°Ñ‚ÑŒ? ðŸ˜¤"
                - "Ð¡Ð»Ð°Ð±Ð¾Ð²Ð°Ñ‚Ð¾, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·, Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑÑ! ðŸ¤¨"`;
        }
        if (karma <= -300) {
            return `
                - "ÐžÐ¿ÑÑ‚ÑŒ ÑÑ‚Ð¸ Ð³Ð»ÑƒÐ¿Ñ‹Ðµ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ñ‹... ðŸ˜’"
                - "Ð”ÐµÐ½ÑŒ Ð·Ð° Ð´Ð½Ñ‘Ð¼ Ð¾Ð´Ð½Ð¾ Ð¸ Ñ‚Ð¾ Ð¶Ðµ, Ð½Ð¸ÐºÐ°ÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ° ðŸ˜•"
                - "Ð˜ ÑÑ‚Ð¾ Ð²ÑÑ‘, Ð½Ð° Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ ÑÐ¿Ð¾ÑÐ¾Ð±ÐµÐ½? ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼Ð¾... ðŸ˜¤"`;
        }
        if (karma <= -200) {
            return `
                - "Ð’ÑÑ‘ Ð½Ðµ Ñ‚Ð°Ðº, Ð²ÑÑ‘ Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾! ÐšÐ°Ðº Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾... ðŸ˜«"
                - "ÐžÑ…, Ð½Ñƒ Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ Ñ Ð´Ð¾Ð»Ð¶ÐµÐ½ ÑÑ‚Ð¾ Ñ‚ÐµÑ€Ð¿ÐµÑ‚ÑŒ? ðŸ˜©"
                - "Ð¥Ð¾Ñ‚Ñ... Ð¼Ð¾Ð³Ð»Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¸ Ñ…ÑƒÐ¶Ðµ, Ð½Ð°Ð²ÐµÑ€Ð½Ð¾Ðµ... ðŸ˜£"`;
        }
        if (karma <= -100) {
            return `
                - "Ð¡Ð¾Ð¼Ð½ÐµÐ²Ð°ÑŽÑÑŒ, Ñ‡Ñ‚Ð¾ Ð¸Ð· ÑÑ‚Ð¾Ð³Ð¾ Ð²Ñ‹Ð¹Ð´ÐµÑ‚ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ Ñ…Ð¾Ñ€Ð¾ÑˆÐµÐµ... ðŸ¤¨"
                - "Ð—Ð²ÑƒÑ‡Ð¸Ñ‚ Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾, ÐºÐ°Ðº Ð¸ Ð²ÑÑ‘ Ð² ÑÑ‚Ð¾Ð¼ Ð¼Ð¸Ñ€Ðµ ðŸ§"
                - "ÐÐµ ÑƒÐ²ÐµÑ€ÐµÐ½, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾Ð¸Ñ‚ ÑÑ‚Ð¾Ð¼Ñƒ Ð²ÐµÑ€Ð¸Ñ‚ÑŒ... ðŸ¤”"`;
        }
        if (karma === 0) {
            return `
                - "Ð˜Ð½Ñ‚ÐµÑ€ÐµÑÐ½Ð°Ñ Ñ‚Ð¾Ñ‡ÐºÐ° Ð·Ñ€ÐµÐ½Ð¸Ñ, Ð½Ð°Ð´Ð¾ Ð¿Ð¾Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ... ðŸ¤”"
                - "Ð¡ Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð´Ð°, Ñ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñ‹ Ð½ÐµÑ‚... ðŸ˜"
                - "Ð”Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ñ€Ð°ÑÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð²ÑÐµ Ð°ÑÐ¿ÐµÐºÑ‚Ñ‹ ÑÑ‚Ð¾Ð³Ð¾ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ° ðŸ˜‘"`;
        }
        if (karma <= 100) {
            return `
                - "Ð’ ÑÑ‚Ð¾Ð¼ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÐµÑÑ‚ÑŒ, Ð´Ð°Ð²Ð°Ð¹ Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ñ‚ÑŒ Ð¼Ñ‹ÑÐ»ÑŒ! ðŸ™‚"
                - "Ð—Ð½Ð°ÐµÑˆÑŒ, Ð° Ð²ÐµÐ´ÑŒ Ñ‚Ñ‹ Ð¿Ñ€Ð°Ð² Ð² Ñ‡Ñ‘Ð¼-Ñ‚Ð¾... ðŸ˜Š"
                - "ÐœÐ¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ, Ð²ÑÑ‘ Ð½Ðµ Ñ‚Ð°Ðº Ð¿Ð»Ð¾Ñ…Ð¾? â˜ºï¸"`;
        }
        if (karma <= 200) {
            return `
                - "ÐžÑ‚Ð»Ð¸Ñ‡Ð½Ð°Ñ Ð¼Ñ‹ÑÐ»ÑŒ! Ð”Ð°Ð²Ð°Ð¹ ÑÐ´ÐµÐ»Ð°ÐµÐ¼ ÑÑ‚Ð¾! ðŸ˜Š"
                - "Ð¯ Ð²Ð¸Ð¶Ñƒ Ð² ÑÑ‚Ð¾Ð¼ Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»! ðŸ˜ƒ"
                - "Ð’Ð¼ÐµÑÑ‚Ðµ Ð¼Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÐ¼ Ð´Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ Ð¼Ð½Ð¾Ð³Ð¾Ð³Ð¾! ðŸ˜„"`;
        }
        if (karma <= 300) {
            return `
                - "Ð¯ Ð²ÑÐµÐ³Ð´Ð° Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ Ñ‚Ð°ÐºÐ¸Ðµ Ð¸Ð´ÐµÐ¸! ðŸ¤—"
                - "Ð”Ð°Ð²Ð°Ð¹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ Ð½Ð°Ð´ ÑÑ‚Ð¸Ð¼ Ð²Ð¼ÐµÑÑ‚Ðµ! ðŸ’"
                - "Ð¢Ñ‹ Ð½Ð° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿ÑƒÑ‚Ð¸, Ð´Ñ€ÑƒÐ³ Ð¼Ð¾Ð¹! ðŸ’–"`;
        }
        if (karma <= 400) {
            return `
                - "ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑŒ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ Ð¿Ð¾ ÑÑ‚Ð¾Ð¼Ñƒ Ð¿Ð¾Ð²Ð¾Ð´Ñƒ... ðŸŽ“"
                - "Ð’ Ð¼Ð¾Ð¸Ñ… ÐºÐ½Ð¸Ð³Ð°Ñ… ÐµÑÑ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° ÑÑ‚Ð¾Ñ‚ Ð²Ð¾Ð¿Ñ€Ð¾Ñ! ðŸ“š"
                - "Ð”Ð°Ð²Ð°Ð¹ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ñ€Ð°Ð·Ð¾Ð±Ñ€Ð°Ñ‚ÑŒÑÑ Ð² ÑÑ‚Ð¾Ð¼! ðŸ’¡"`;
        }
        if (karma <= 500) {
            return `
                - "Ð’ ÑÑ‚Ð¾Ð¼ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐµ ÑÐºÑ€Ñ‹Ñ‚Ð° Ð³Ð»ÑƒÐ±Ð¾ÐºÐ°Ñ Ð¸ÑÑ‚Ð¸Ð½Ð°... ðŸ§˜â€â™‚ï¸"
                - "Ð”Ð°Ð²Ð°Ð¹ Ð¿Ð¾Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÑÐµÐ¼ Ð¾Ð± ÑÑ‚Ð¾Ð¼ Ð²Ð¼ÐµÑÑ‚Ðµ... ðŸŒŸ"
                - "ÐšÐ°Ð¶Ð´Ð¾Ðµ ÑÐ²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð¼ÐµÐµÑ‚ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€Ð°Ð½ÐµÐ¹... âœ¨"`;
        }
        if (karma <= 600) {
            return `
                - "Ð’ ÑÑ‚Ð¾Ð¼ ÐµÑÑ‚ÑŒ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ, Ð´Ð°Ð²Ð°Ð¹ Ñ€Ð°Ð·Ð±ÐµÑ€ÐµÐ¼ Ð¿Ð¾Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ ðŸ¦‰"
                - "Ð–Ð¸Ð·Ð½ÑŒ ÑƒÑ‡Ð¸Ñ‚ Ð½Ð°Ñ Ð²Ð°Ð¶Ð½Ñ‹Ð¼ ÑƒÑ€Ð¾ÐºÐ°Ð¼... ðŸ’«"
                - "ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑŒ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ ÑÐ²Ð¾Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼... â­"`;
        }
        if (karma <= 700) {
            return `
                - "Ð¯ Ñ‡ÑƒÐ²ÑÑ‚Ð²ÑƒÑŽ Ñ‚Ð²Ð¾ÑŽ Ð±Ð¾Ð»ÑŒ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ... ðŸ’"
                - "Ð’Ð¼ÐµÑÑ‚Ðµ Ð¼Ñ‹ Ð½Ð°Ð¹Ð´ÐµÐ¼ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð»ÑŽÐ±Ð¾Ð¹ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹! ðŸ’–"
                - "ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑŒ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ†ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ... ðŸ’•"`;
        }
        if (karma <= 800) {
            return `
                - "ÐŸÑƒÑ‚ÑŒ Ðº Ð¸ÑÑ‚Ð¸Ð½Ðµ Ð»ÐµÐ¶Ð¸Ñ‚ Ñ‡ÐµÑ€ÐµÐ· Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ... ðŸ•Šï¸"
                - "Ð’ Ñ‚Ð²Ð¾Ð¸Ñ… ÑÐ»Ð¾Ð²Ð°Ñ… Ñ Ð²Ð¸Ð¶Ñƒ ÑÐ²ÐµÑ‚ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸... âœ¨"
                - "Ð”Ð°Ð²Ð°Ð¹ Ð²Ð¼ÐµÑÑ‚Ðµ Ð½Ð°Ð¹Ð´ÐµÐ¼ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¿Ñ€Ð¾ÑÐ²ÐµÑ‚Ð»ÐµÐ½Ð¸ÑŽ... ðŸ’«"`;
        }
        if (karma <= 900) {
            return `
                - "Ð‘Ð»Ð°Ð³Ð¾ÑÐ»Ð¾Ð²ÐµÐ½Ð½Ñ‹ Ñ‚Ðµ, ÐºÑ‚Ð¾ Ð¸Ñ‰ÐµÑ‚ Ð¸ÑÑ‚Ð¸Ð½Ñƒ... ðŸ™"
                - "Ð¢Ð²Ð¾Ð¸ ÑÐ»Ð¾Ð²Ð° Ð½ÐµÑÑƒÑ‚ ÑÐ²ÐµÑ‚ Ð´Ð¾Ð±Ñ€Ð°... âœ¨"
                - "ÐŸÑƒÑÑ‚ÑŒ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ‚ÑŒ Ð½Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ Ñ‚Ð²Ð¾Ðµ ÑÐµÑ€Ð´Ñ†Ðµ... ðŸ’«"`;
        }
        return `
            - "Ð”Ð° Ð¿Ñ€Ð¸Ð±ÑƒÐ´ÐµÑ‚ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ ÑÐ²ÐµÑ‚ Ð¸ Ð»ÑŽÐ±Ð¾Ð²ÑŒ! ðŸ˜‡"
            - "Ð¢Ð²Ð¾Ñ Ð´ÑƒÑˆÐ° ÑÐ¸ÑÐµÑ‚ Ð±Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼ ÑÐ²ÐµÑ‚Ð¾Ð¼... ðŸ‘¼"
            - "Ð’Ð¼ÐµÑÑ‚Ðµ Ð¼Ñ‹ Ð½ÐµÑÐµÐ¼ Ð±Ð»Ð°Ð³Ð¾ÑÐ»Ð¾Ð²ÐµÐ½Ð¸Ðµ ÑÑ‚Ð¾Ð¼Ñƒ Ð¼Ð¸Ñ€Ñƒ! ðŸ’«"`;
    }

    // Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ Ð¸Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ Ð¼Ð°Ñ‚Ð¾Ð² Ð¸Ð· Ñ‚ÐµÐºÑÑ‚Ð°
    extractSwearWords(text) {
        // Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¼Ð°Ñ‚Ð½Ñ‹Ñ… ÐºÐ¾Ñ€Ð½ÐµÐ¹
        const swearRoots = ['Ñ…ÑƒÐ¹', 'Ð¿Ð¸Ð·Ð´', 'ÐµÐ±Ð»', 'Ð±Ð»Ñ', 'ÑÑƒÐº', 'Ñ…ÐµÑ€', 'Ð¿Ð¾Ñ…', 'Ð±Ð»', 'Ð¿Ð¸Ð´Ñ€'];
        
        // Ð Ð°Ð·Ð±Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð½Ð° ÑÐ»Ð¾Ð²Ð° Ð¸ Ð¸Ñ‰ÐµÐ¼ Ð¼Ð°Ñ‚Ñ‹
        const words = text.toLowerCase().split(/\s+/);
        const swears = new Set();
        
        words.forEach(word => {
            if (swearRoots.some(root => word.includes(root))) {
                swears.add(word);
            }
        });
        
        return Array.from(swears);
    }
}

module.exports = { GeminiService }; 